# ==============================================================================
# MEGA MECHANISM SWEEP - Test Registry
# ==============================================================================
#
# This file registers all tests for comparing mechanisms M0-M4.
# Each test specifies: data source, channels, resonances, likelihood type,
# and systematic treatment.
#
# Mechanisms compared:
#   M0: Rank-1 bottleneck / factorization (YOUR model)
#   M1: Unconstrained coherent mixture (standard baseline)
#   M2: Incoherent sum (no interference)
#   M3: K-matrix/P-vector (where applicable)
#   M4: Rank-2 generalization (for >2 channel tests)
# ==============================================================================

tests:
  # ============================================================================
  # CMS X(6900)/X(7100) - FLAGSHIP TEST (SUPPORTED in v3)
  # ============================================================================
  - name: "cms_x6900_x7100_v3"
    display_name: "CMS X(6900)/X(7100) Di-J/psi"
    experiment: "CMS"
    paper_ref: "CMS-BPH-21-003 / arXiv:2306.07164"
    data_source: "local_csv"  # Vector extraction from CMS figure
    data_path: "rank1_test_v2/data/"
    data_fidelity: "vector_extraction"

    channel_A:
      name: "4mu"
      data_file: "4mu_bins.csv"
      observable: "counts"

    channel_B:
      name: "2mu2e"
      data_file: "2mu2e_bins.csv"
      observable: "counts"

    resonances:
      BW1:
        name: "X(6900)"
        mass_gev: 6.905
        width_gev: 0.150
        fixed: false
      BW2:
        name: "X(7100)"
        mass_gev: 7.10
        width_gev: 0.100
        fixed: false

    likelihood_type: "poisson"

    systematics:
      scale_uncertainty: 0.01
      baseline_shift_mev: 20
      y_scale_uncertainty: 0.02
      treatment: "nuisance_gaussian"

    background:
      model: "chebyshev"
      order: 2
      threshold_factor: true

    fit_windows:
      wide: [6.2, 9.5]

    fit_health_gates:
      chi2_dof_min: 0.5
      chi2_dof_max: 3.0
      deviance_dof_max: 3.0

    optimizer:
      n_starts: 300
      n_bootstrap: 500

    prior_verdict: "SUPPORTED"
    prior_p_value: 0.403
    prior_Lambda: 1.82

    amplitude_level: true
    status: "testable"

  # ============================================================================
  # ATLAS X(6900)/X(7200) - v5 (MODEL MISMATCH in 4mu+2pi channel)
  # ============================================================================
  - name: "atlas_x6900_x7200_v5"
    display_name: "ATLAS X(6900)/X(7200) Di-Charmonium"
    experiment: "ATLAS"
    paper_ref: "ATLAS arXiv:2304.08962 / arXiv:2509.13101"
    data_source: "local_csv"  # Figure extraction
    data_path: "atlas_rank1_test_v5/data/derived/"
    data_fidelity: "figure_extraction"

    channel_A:
      name: "4mu"
      data_file: "4mu_bins.csv"
      observable: "counts"

    channel_B:
      name: "4mu+2pi"
      data_file: "4mu+2pi_bins.csv"
      observable: "counts"

    resonances:
      BW1:
        name: "X(6900)"
        mass_gev: 6.905
        width_gev: 0.150
        fixed: false
      BW2:
        name: "X(7200)"
        mass_gev: 7.22
        width_gev: 0.100
        fixed: false
      BW_thresh:
        name: "threshold"
        mass_gev: 6.40
        width_gev: 0.40
        fixed: false

    likelihood_type: "poisson"

    systematics:
      scale_uncertainty: 0.01
      baseline_shift_mev: 20
      y_scale_uncertainty: 0.02
      treatment: "nuisance_gaussian"

    background:
      model: "chebyshev_threshold"
      order: 2

    fit_windows:
      wide: [6.8, 9.5]

    fit_health_gates:
      chi2_dof_min: 0.5
      chi2_dof_max: 3.0
      deviance_dof_max: 3.0

    optimizer:
      n_starts: 30
      n_bootstrap: 300

    prior_verdict: "MODEL MISMATCH"
    prior_reason: "4mu+2pi chi2/dof=9.74 >> 3.0"

    amplitude_level: true
    status: "model_mismatch"
    notes: "4mu+2pi channel has severe model mismatch"

  # ============================================================================
  # LHCb Pentaquarks Pc(4440)/Pc(4457) - PROXY TEST (SUPPORTED with quadratic bg)
  # ============================================================================
  - name: "lhcb_pentaquark_pair1_quad"
    display_name: "LHCb Pentaquark Pair1 T1vsT2 (quad bg)"
    experiment: "LHCb"
    paper_ref: "PRL 122, 222001 (2019) / LHCb-PAPER-2019-014"
    data_source: "cds_supplementary"
    data_path: "lhcb_rank1_test_v2/data/"
    data_fidelity: "official_supplementary"

    channel_A:
      name: "T1_m(J/psi p)"
      observable: "weighted_counts"

    channel_B:
      name: "T2_m(J/psi p)"
      observable: "weighted_counts"

    resonances:
      BW1:
        name: "Pc(4440)"
        mass_mev: 4440.3
        width_mev: 20.6
        fixed: true
      BW2:
        name: "Pc(4457)"
        mass_mev: 4457.3
        width_mev: 6.4
        fixed: true

    likelihood_type: "poisson"

    systematics:
      treatment: "nuisance_gaussian"

    background:
      model: "polynomial"
      order: 2  # quadratic

    fit_windows:
      wide: [4270, 4520]
      tight: [4320, 4490]

    fit_health_gates:
      chi2_dof_min: 0.5
      chi2_dof_max: 3.0

    optimizer:
      n_starts: 100
      n_bootstrap: 200

    prior_verdict: "SUPPORTED"
    prior_p_value: 0.40
    prior_chi2_A: 1.70
    prior_chi2_B: 1.15

    amplitude_level: false
    proxy_test: true
    status: "testable"
    notes: "Yield-ratio proxy test. Passes gates with quadratic background."

  - name: "lhcb_pentaquark_pair2_quad"
    display_name: "LHCb Pentaquark Pair2 T1vsT3 (quad bg)"
    experiment: "LHCb"
    paper_ref: "PRL 122, 222001 (2019)"
    data_source: "cds_supplementary"
    data_path: "lhcb_rank1_test_v2/data/"
    data_fidelity: "official_supplementary"

    channel_A:
      name: "T1_m(J/psi p)"
      observable: "weighted_counts"

    channel_B:
      name: "T3_m(J/psi p)"
      observable: "weighted_counts"

    resonances:
      BW1:
        name: "Pc(4440)"
        mass_mev: 4440.3
        width_mev: 20.6
        fixed: true
      BW2:
        name: "Pc(4457)"
        mass_mev: 4457.3
        width_mev: 6.4
        fixed: true

    likelihood_type: "poisson"

    background:
      model: "polynomial"
      order: 2

    fit_windows:
      wide: [4270, 4520]

    fit_health_gates:
      chi2_dof_min: 0.5
      chi2_dof_max: 3.0

    optimizer:
      n_starts: 100
      n_bootstrap: 200

    prior_verdict: "SUPPORTED"
    prior_p_value: 0.32

    amplitude_level: false
    proxy_test: true
    status: "testable"

  # ============================================================================
  # BaBar phi-f0(980) vs phi-pi+pi- - DISFAVORED for rank-1
  # ============================================================================
  - name: "babar_phi_f0_vs_phi_pipi"
    display_name: "BaBar phi-f0(980) vs phi-pi+pi-"
    experiment: "BaBar"
    paper_ref: "PRD 86, 012008 (2012)"
    data_source: "hepdata"
    hepdata_record: "ins892684"
    hepdata_doi: "10.17182/hepdata.62222"
    data_fidelity: "hepdata_numeric"

    channel_A:
      name: "phi pi+pi-"
      table_number: 3
      observable: "cross_section"

    channel_B:
      name: "phi f0(980)"
      table_number: 4
      observable: "cross_section"

    resonances:
      BW1:
        name: "phi(1680)"
        mass_gev: 1.680
        width_gev: 0.150
        source: "PDG 2024"
      BW2:
        name: "phi(2170)/Y(2175)"
        mass_gev: 2.162
        width_gev: 0.100
        source: "PDG 2024"

    likelihood_type: "gaussian"

    systematics:
      correlated_scale_A: 0.10
      correlated_scale_B: 0.10
      treatment: "nuisance_gaussian"

    background:
      model: "constant_complex"
      order: 0

    fit_windows:
      wide: [1.5, 2.5]

    fit_health_gates:
      chi2_dof_min: 0.5
      chi2_dof_max: 3.0

    optimizer:
      n_starts: 300
      n_bootstrap: 800

    prior_verdict: "DISFAVORED"
    prior_p_value: 0.0
    prior_Lambda: 342.14
    prior_chi2_A: 1.14
    prior_chi2_B: 2.82

    amplitude_level: true
    status: "testable"
    notes: "Strong rejection of rank-1 constraint"

  # ============================================================================
  # BaBar omega(1420)/omega(1650) - MODEL MISMATCH (underconstrained)
  # ============================================================================
  - name: "babar_omega_1420_1650"
    display_name: "BaBar omega(1420)/omega(1650)"
    experiment: "BaBar"
    paper_ref: "PRD 76, 092005 (2007)"
    data_source: "hepdata"
    hepdata_record: "51824"
    hepdata_doi: "10.17182/hepdata.51824"
    data_fidelity: "hepdata_numeric"

    channel_A:
      name: "omega pi+pi-"
      table_number: 3
      observable: "cross_section"

    channel_B:
      name: "omega f0(980)"
      table_number: 4
      observable: "cross_section"

    resonances:
      BW1:
        name: "omega(1420)"
        mass_gev: 1.420
        width_gev: 0.290
        source: "PDG 2024"
      BW2:
        name: "omega(1650)"
        mass_gev: 1.670
        width_gev: 0.315
        source: "PDG 2024"

    likelihood_type: "gaussian"

    systematics:
      correlated_scale_A: 0.10
      correlated_scale_B: 0.10
      treatment: "nuisance_gaussian"

    background:
      model: "constant_complex"
      order: 0

    fit_windows:
      wide: [1.2, 2.2]

    fit_health_gates:
      chi2_dof_min: 0.5
      chi2_dof_max: 3.0

    optimizer:
      n_starts: 300
      n_bootstrap: 800

    prior_verdict: "MODEL MISMATCH"
    prior_reason: "Underconstrained chi2/dof < 0.5"
    prior_chi2_A: 0.007
    prior_chi2_B: 0.000004

    amplitude_level: true
    status: "model_mismatch"
    notes: "Data too sparse for 2-BW coherent model"

  # ============================================================================
  # Y-states Belle/BaBar - INCONCLUSIVE (underconstrained)
  # ============================================================================
  - name: "y_states_belle_babar"
    display_name: "Y(4220)/Y(4360) Belle vs BaBar"
    experiment: "Belle/BaBar"
    paper_ref: "Multiple papers"
    data_source: "local_csv"
    data_path: "y_rank1_test_v2/data/"
    data_fidelity: "hepdata_numeric"

    channel_A:
      name: "Belle pi+pi- J/psi"
      observable: "cross_section"

    channel_B:
      name: "BaBar pi+pi- psi(2S)"
      observable: "cross_section"

    resonances:
      BW1:
        name: "Y(4220)"
        mass_gev: 4.222
        width_gev: 0.044
      BW2:
        name: "Y(4360)"
        mass_gev: 4.368
        width_gev: 0.096

    likelihood_type: "gaussian"

    systematics:
      treatment: "nuisance_gaussian"

    background:
      model: "polynomial"
      order: 1

    fit_windows:
      wide: [4.0, 4.6]

    fit_health_gates:
      chi2_dof_min: 0.5
      chi2_dof_max: 3.0

    optimizer:
      n_starts: 300
      n_bootstrap: 500

    prior_verdict: "INCONCLUSIVE"
    prior_reason: "Channel B underconstrained: chi2/dof=0.36"
    prior_p_value: 0.732
    prior_chi2_A: 0.70
    prior_chi2_B: 0.36

    amplitude_level: true
    status: "inconclusive"
    notes: "Channel B (BaBar) underconstrained; multimodal r"

  # ============================================================================
  # BESIII Y(4220)/Y(4360) - INCONCLUSIVE (Channel B poor fit)
  # ============================================================================
  - name: "besiii_y_states"
    display_name: "BESIII Y(4220)/Y(4360)"
    experiment: "BESIII"
    paper_ref: "PRL 118, 092001 (2017) & PRD 104, 052012 (2021)"
    data_source: "hepdata"
    data_fidelity: "hepdata_numeric"

    channel_A:
      name: "pi+pi- J/psi"
      observable: "cross_section"

    channel_B:
      name: "pi+pi- psi(3686)"
      observable: "cross_section"

    resonances:
      BW1:
        name: "Y(4220)"
        mass_gev: 4.222
        width_gev: 0.044
      BW2:
        name: "Y(4360)"
        mass_gev: 4.368
        width_gev: 0.096

    likelihood_type: "gaussian"

    systematics:
      correlated_syst_A: 0.058
      correlated_syst_B: 0.046
      treatment: "nuisance_gaussian"

    background:
      model: "polynomial"
      order: 1

    fit_windows:
      wide: [4.1, 4.5]

    fit_health_gates:
      chi2_dof_min: 0.5
      chi2_dof_max: 3.0

    optimizer:
      n_starts: 300
      n_bootstrap: 800

    prior_verdict: "INCONCLUSIVE"
    prior_reason: "Channel B chi2/dof=8.8 >> 3.0"
    prior_chi2_A: 1.66
    prior_chi2_B: 8.82

    amplitude_level: true
    status: "model_mismatch"
    notes: "Channel B (psi(3686)) has poor fit quality"

  # ============================================================================
  # BaBar K*(892)K isospin - MODEL MISMATCH (underconstrained)
  # ============================================================================
  - name: "babar_kstar_k_isospin"
    display_name: "BaBar K*(892)K I=0 vs I=1"
    experiment: "BaBar"
    paper_ref: "PRD 77, 092002 (2008)"
    data_source: "hepdata"
    hepdata_record: "ins765258"
    hepdata_doi: "10.17182/hepdata.50372"
    data_fidelity: "hepdata_numeric"

    channel_A:
      name: "K*(892)K I=0"
      table_number: 6
      observable: "cross_section"

    channel_B:
      name: "K*(892)K I=1"
      table_number: 7
      observable: "cross_section"

    resonances:
      BW1:
        name: "phi(1680)"
        mass_gev: 1.680
        width_gev: 0.150
      BW2:
        name: "phi(2170)"
        mass_gev: 2.162
        width_gev: 0.100

    likelihood_type: "gaussian"

    systematics:
      correlated_scale_A: 0.07
      correlated_scale_B: 0.07
      treatment: "nuisance_gaussian"

    background:
      model: "constant_complex"
      order: 0

    fit_windows:
      wide: [1.4, 2.4]

    fit_health_gates:
      chi2_dof_min: 0.5
      chi2_dof_max: 3.0

    optimizer:
      n_starts: 300
      n_bootstrap: 800

    prior_verdict: "MODEL MISMATCH"
    prior_reason: "chi2/dof << 0.5 (underconstrained)"
    prior_chi2_A: 0.01
    prior_chi2_B: 0.01

    amplitude_level: true
    status: "model_mismatch"
    notes: "2-BW model too flexible for sparse data"

  # ============================================================================
  # BaBar phi-eta vs K+K-eta - MODEL MISMATCH (underconstrained)
  # ============================================================================
  - name: "babar_phi_eta_vs_kketa"
    display_name: "BaBar phi-eta vs K+K-eta"
    experiment: "BaBar"
    paper_ref: "PRD 77, 092002 (2008)"
    data_source: "hepdata"
    hepdata_record: "ins765258"
    hepdata_doi: "10.17182/hepdata.50372"
    data_fidelity: "hepdata_numeric"

    channel_A:
      name: "phi eta"
      table_number: 5
      observable: "cross_section"

    channel_B:
      name: "K+K- eta (excl phi)"
      table_number: 4
      observable: "cross_section"

    resonances:
      BW1:
        name: "phi(1680)"
        mass_gev: 1.680
        width_gev: 0.150
      BW2:
        name: "phi(2170)"
        mass_gev: 2.162
        width_gev: 0.100

    likelihood_type: "gaussian"

    systematics:
      correlated_scale_A: 0.10
      correlated_scale_B: 0.10
      treatment: "nuisance_gaussian"

    background:
      model: "constant_complex"
      order: 0

    fit_windows:
      wide: [1.6, 2.8]

    fit_health_gates:
      chi2_dof_min: 0.5
      chi2_dof_max: 3.0

    optimizer:
      n_starts: 300
      n_bootstrap: 800

    prior_verdict: "MODEL MISMATCH"
    prior_reason: "chi2/dof << 0.5 (underconstrained)"
    prior_chi2_A: 0.02
    prior_chi2_B: 0.02

    amplitude_level: true
    status: "model_mismatch"
    notes: "Signal too weak relative to model complexity"

# ==============================================================================
# MECHANISM DEFINITIONS
# ==============================================================================
mechanisms:
  M0:
    name: "Rank-1 Bottleneck (Factorization)"
    description: "Couplings factorize: g_{ia} = a_i * c_a. For 2-state, 2-channel: shared complex ratio R_A = R_B"
    n_params_per_channel: 6  # c1, c2, phi, bg_re, bg_im, s0
    n_shared_params: 2  # r, phi (shared)
    nested_in: "M1"

  M1:
    name: "Unconstrained Coherent"
    description: "Each channel has independent complex ratios R_a, shared masses/widths"
    n_params_per_channel: 6
    n_shared_params: 0
    baseline: true

  M2:
    name: "Incoherent Sum"
    description: "Intensity = sum |BW_i|^2 + background, no interference"
    n_params_per_channel: 5  # |c1|^2, |c2|^2, bg coeffs, s0
    n_shared_params: 0
    nested_in: "M1"

  M3:
    name: "K-matrix P-vector rank-1"
    description: "F = (I - iKrho)^{-1} P with rank-1 P-vector"
    applicable_to: ["cms_x6900_x7100_v3"]  # Only where feasible

  M4:
    name: "Rank-2 Generalization"
    description: "g_{ia} = a_i*c_a + b_i*d_a (for >2 channels or validating rank-1)"
    applicable_to: []  # Define when multi-channel tests available

# ==============================================================================
# GLOBAL SETTINGS
# ==============================================================================
global_settings:
  n_starts_default: 300
  n_bootstrap_default: 500
  optimizers: ["L-BFGS-B", "Powell"]
  fit_health_gates:
    chi2_dof_min: 0.5
    chi2_dof_max: 3.0
    deviance_dof_max: 3.0
  verdict_rules:
    SUPPORTED: "gates_pass AND p_boot >= 0.05 AND shared_in_both_95cl"
    DISFAVORED: "gates_pass AND p_boot < 0.05 AND NOT shared_in_both_95cl"
    INCONCLUSIVE: "gates_pass AND multimodal OR mixed_evidence"
    MODEL_MISMATCH: "NOT gates_pass (chi2/dof outside [0.5, 3.0])"
    NO_DATA: "Could not load numeric data"
    OPTIMIZER_FAILURE: "Lambda < 0 after max restarts"
